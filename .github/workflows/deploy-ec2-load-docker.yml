on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment (dev, uat, prod)"
        required: true
        type: string
      docker_image_name:
        description: "Docker image name"
        required: true
        type: string
      s3_path:
        description: "S3 path prefix for downloads"
        required: true
        type: string
    secrets:
      IAM_ROLE_ARN:
        description: "AWS IAM Role ARN for OIDC authentication"
        required: true
      EC2_INSTANCE_ID:
        description: "Target EC2 Instance ID"
        required: true

jobs:
  load-docker-image:
    name: Load Docker Image to EC2 from S3
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: read

    env:
      IAM_ROLE_ARN: ${{ secrets.IAM_ROLE_ARN }}
      EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
      AWS_REGION: ap-south-1
      S3_BUILD_BUCKET: ${{ vars.S3_BUILD_BUCKET }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout sgx-github-actions workflow repository
        uses: actions/checkout@v4
        with:
          repository: Ennovative-Genix/sgx-github-actions
          ref: main
          sparse-checkout: .github/scripts
          sparse-checkout-cone-mode: false
          path: workflow-repo

      - name: Make poll-ssm-command.sh executable
        run: chmod +x workflow-repo/.github/scripts/poll-ssm-command.sh

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-EC2-Load-Docker-${{ github.run_id }}

      - name: Prune unused images from Docker (via SSM)
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ env.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters "{\"commands\":[\"docker image prune -f\"]}" \
            --region "${{ env.AWS_REGION }}" \
            --query 'Command.CommandId' \
            --output text)

          workflow-repo/.github/scripts/poll-ssm-command.sh "$COMMAND_ID" "${{ env.EC2_INSTANCE_ID }}" "${{ env.AWS_REGION }}" "Prune unused images from Docker"

      - name: Copy Docker Image from S3 to EC2 Instance (via SSM)
        run: |
          S3_SOURCE="s3://${{ env.S3_BUILD_BUCKET }}/${{ inputs.s3_path }}/latest.tar.gz"
          DEST_PATH="/var/tmp/${{ inputs.docker_image_name }}-latest.tar.gz"
          SSM_COMMAND="aws s3 cp ${S3_SOURCE} ${DEST_PATH} --region ${{ env.AWS_REGION }}"

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ env.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters "{\"commands\":[\"${SSM_COMMAND}\"]}" \
            --region "${{ env.AWS_REGION }}" \
            --query 'Command.CommandId' \
            --output text)

          workflow-repo/.github/scripts/poll-ssm-command.sh "$COMMAND_ID" "${{ env.EC2_INSTANCE_ID }}" "${{ env.AWS_REGION }}" "Copy Docker Image from S3"

      - name: Load Docker image into Docker on EC2
        run: |
          TAR_FILE="/var/tmp/${{ inputs.docker_image_name }}-latest.tar.gz"

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ env.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters "{\"commands\":[\"ls -lh /var/tmp/\",\"gunzip -c ${TAR_FILE} | docker load\"]}" \
            --region "${{ env.AWS_REGION }}" \
            --query 'Command.CommandId' \
            --output text)

          workflow-repo/.github/scripts/poll-ssm-command.sh "$COMMAND_ID" "${{ env.EC2_INSTANCE_ID }}" "${{ env.AWS_REGION }}" "Load Docker Image"
