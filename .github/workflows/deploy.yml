name: Build and Deploy UI (Angular)

run-name: Build and Deploy UI - ${{ inputs.environment || (startsWith(github.ref_name, 'release/') && 'UAT' || (github.ref_name == 'main') && 'PROD' || 'DEV') }}

on:
  # Direct trigger on push
  push:
    branches:
      - develop
      - release/**
      - main

  # Reusable workflow trigger
  workflow_call:
    inputs:
      environment:
        description: "Target environment (dev, uat, prod)"
        required: true
        type: string
      ref:
        description: "Git ref to checkout (branch, tag, or SHA)"
        required: false
        type: string
        default: ""
    secrets:
      IAM_ROLE_ARN:
        description: "AWS IAM Role ARN for OIDC authentication"
        required: true
      EC2_INSTANCE_ID:
        description: "Target EC2 Instance ID"
        required: true

jobs:
  pre-build:
    name: Pre-Build
    runs-on: ubuntu-latest
    steps:
      - name: Free up disk space
        run: |
          echo "=== Initial disk usage ==="
          df -h
          echo ""
          echo "=== Removing unnecessary packages and tools ==="
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          echo ""
          echo "=== Cleaning apt cache ==="
          sudo apt-get clean
          echo ""
          echo "=== Pruning Docker ==="
          docker system prune -a -f --volumes
          docker builder prune -a -f

      - name: Check disk usage after pre-build
        run: |
          df -h
          docker system df

  build-and-upload:
    name: Build and Upload
    runs-on: ubuntu-latest
    needs: pre-build
    environment: ${{ inputs.environment || (startsWith(github.ref_name, 'release/') && 'uat' || ((github.ref_name == 'main') && 'prod') || 'dev') }}
    env:
      IAM_ROLE_ARN: ${{ secrets.IAM_ROLE_ARN }}
      EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
      AWS_REGION: ${{ vars.AWS_REGION }}
      S3_BUILD_BUCKET: ${{ vars.S3_BUILD_BUCKET }}
      PORT_MAPPING: ${{ vars.PORT_MAPPING }}
      TARGET_ENV: ${{ inputs.environment || (startsWith(github.ref_name, 'release/') && 'uat' || ((github.ref_name == 'main') && 'prod') || 'dev') }}

    permissions:
      id-token: write
      contents: read

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Build Angular Project
        run: |
          if [[ "${{ env.TARGET_ENV }}" == "uat" ]]; then
            npm run build:uat
          elif [[ "${{ env.TARGET_ENV }}" == "prod" ]]; then
            npm run build:prod
          else
            npm run build:dev
          fi

      - name: Docker build (nginx image for frontend)
        run: |
          docker build -f Dockerfile -t teampulse-frontend:latest .
          echo "Docker image teampulse-frontend:latest built"

      - name: Configure AWS Credentials (OIDC - No Access Keys)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-SSM-Command-${{ github.run_id }}

      - name: Upload "latest" to S3 (STANDARD)
        run: |
          aws s3 cp teampulse-frontend-latest.tar.gz s3://${{ env.S3_BUILD_BUCKET }}/teampulse/frontend/latest.tar.gz --region ${{ env.AWS_REGION }} --storage-class STANDARD

      - name: Upload "sha" to S3 (GLACIER_IR)
        run: |
          aws s3 cp teampulse-frontend-latest.tar.gz s3://${{ env.S3_BUILD_BUCKET }}/teampulse/frontend/${{ github.sha }}.tar.gz --region ${{ env.AWS_REGION }} --storage-class GLACIER_IR

  load-docker-image:
    name: Load Docker Image to EC2
    runs-on: ubuntu-latest
    needs: build-and-upload
    environment: ${{ inputs.environment || (startsWith(github.ref_name, 'release/') && 'uat' || ((github.ref_name == 'main') && 'prod') || 'dev') }}
    permissions:
      id-token: write
      contents: read

    env:
      IAM_ROLE_ARN: ${{ secrets.IAM_ROLE_ARN }}
      EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
      AWS_REGION: ${{ vars.AWS_REGION }}
      S3_BUILD_BUCKET: ${{ vars.S3_BUILD_BUCKET }}
      PORT_MAPPING: ${{ vars.PORT_MAPPING }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Make poll-ssm-command.sh executable
        run: chmod +x .github/scripts/poll-ssm-command.sh

      - name: Configure AWS credentials (OIDC) for deploy
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-EC2-Deploy-${{ github.run_id }}

      - name: Copy Docker Image from S3 to EC2 Instance (via SSM)
        id: copy-s3-file
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ env.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters '{"commands":["aws s3 cp s3://'${{ env.S3_BUILD_BUCKET }}'/teampulse/frontend/latest.tar.gz /var/tmp/teampulse-frontend-latest.tar.gz --region '${{ env.AWS_REGION }}'"]}' \
            --region ${{ env.AWS_REGION }} \
            --query 'Command.CommandId' \
            --output text)

          .github/scripts/poll-ssm-command.sh "$COMMAND_ID" "${{ env.EC2_INSTANCE_ID }}" "${{ env.AWS_REGION }}" "Copy Docker Image from S3"

      - name: Run SSM command to load docker image into Docker
        run: |
          COMMAND_ID=$(aws ssm send-command \
          --instance-ids ${{ env.EC2_INSTANCE_ID }} \
          --document-name "AWS-RunShellScript" \
          --parameters '{"commands":["ls -lh /var/tmp/","gunzip -c /var/tmp/teampulse-frontend-latest.tar.gz | docker load"]}' \
          --region ${{ env.AWS_REGION }} \
          --query 'Command.CommandId' \
          --output text)

          .github/scripts/poll-ssm-command.sh "$COMMAND_ID" "${{ env.EC2_INSTANCE_ID }}" "${{ env.AWS_REGION }}" "Load Docker Image"

  start-docker-container:
    name: Start Docker Container on EC2 Instance
    runs-on: ubuntu-latest
    needs: [load-docker-image]
    environment: ${{ inputs.environment || (startsWith(github.ref_name, 'release/') && 'uat' || ((github.ref_name == 'main') && 'prod') || 'dev') }}
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_SECRETS_ARN: ${{ secrets.AWS_SECRETS_ARN }}
      EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
      IAM_ROLE_ARN: ${{ secrets.IAM_ROLE_ARN }}
      PORT_MAPPING: ${{ vars.PORT_MAPPING }}
      CLOUDWATCH_LOG_GROUP: ${{ vars.CLOUDWATCH_LOG_GROUP }}
      CLOUDWATCH_LOG_STREAM: ${{ vars.CLOUDWATCH_LOG_STREAM }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Make poll-ssm-command.sh executable
        run: chmod +x .github/scripts/poll-ssm-command.sh

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-EC2-Start-Docker-Container-${{ github.run_id }}

      - name: Copy docker-compose.yml to EC2 Instance
        run: |
          COMPOSE_CONTENT=$(cat docker-compose.yml | base64 | tr -d '\n')
          COMMAND="echo $COMPOSE_CONTENT | base64 -d > /var/tmp/docker-compose.yml"
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ env.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters "{\"commands\":[\"$COMMAND\"]}" \
            --region ${{ env.AWS_REGION }} \
            --query 'Command.CommandId' \
            --output text)

          .github/scripts/poll-ssm-command.sh "$COMMAND_ID" "${{ env.EC2_INSTANCE_ID }}" "${{ env.AWS_REGION }}" "Copy docker-compose.yml"

      - name: Run SSM command to stop Docker container
        run: |
          COMMAND_ID=$(aws ssm send-command \
          --instance-ids ${{ env.EC2_INSTANCE_ID }} \
          --document-name "AWS-RunShellScript" \
          --parameters '{"commands":["cd /var/tmp && docker compose down || true"]}' \
          --region ${{ env.AWS_REGION }} \
          --query 'Command.CommandId' \
          --output text)

          .github/scripts/poll-ssm-command.sh "$COMMAND_ID" "${{ env.EC2_INSTANCE_ID }}" "${{ env.AWS_REGION }}" "Stop Docker Container"

      - name: Run SSM command to start Docker container
        run: |
          COMMAND_ID=$(aws ssm send-command \
          --instance-ids ${{ env.EC2_INSTANCE_ID }} \
          --document-name "AWS-RunShellScript" \
          --parameters '{"commands":["cd /var/tmp && PORT_MAPPING=${{ env.PORT_MAPPING }} AWS_REGION=${{ env.AWS_REGION }} CLOUDWATCH_LOG_GROUP=${{ env.CLOUDWATCH_LOG_GROUP }} CLOUDWATCH_LOG_STREAM=${{ env.CLOUDWATCH_LOG_STREAM }} docker compose up -d"]}' \
          --region ${{ env.AWS_REGION }} \
          --query 'Command.CommandId' \
          --output text)

          .github/scripts/poll-ssm-command.sh "$COMMAND_ID" "${{ env.EC2_INSTANCE_ID }}" "${{ env.AWS_REGION }}" "Start Docker Container"

      - name: Clean up tar file
        run: |
          COMMAND_ID=$(aws ssm send-command \
          --instance-ids ${{ env.EC2_INSTANCE_ID }} \
          --document-name "AWS-RunShellScript" \
          --parameters '{"commands":["rm -f /var/tmp/teampulse-frontend-latest.tar.gz || true"]}' \
          --region ${{ env.AWS_REGION }} \
          --query 'Command.CommandId' \
          --output text)

          .github/scripts/poll-ssm-command.sh "$COMMAND_ID" "${{ env.EC2_INSTANCE_ID }}" "${{ env.AWS_REGION }}" "Clean up files"
